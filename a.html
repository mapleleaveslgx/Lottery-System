<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026é»å·å¿æ•™è‚²ä½“è‚²å±€å¹´ä¼šæŠ½å¥–</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS3DRenderer.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-bg-1: #E3F2F5;  
            --color-bg-2: #E3EBF8;  
            --text-primary: #4A5568; 
            --text-accent: #2D3748;
        }

        body { 
            margin: 0; 
            background: linear-gradient(135deg, var(--color-bg-1) 0%, #fff 50%, var(--color-bg-2) 100%); 
            overflow: hidden; 
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; 
            color: var(--text-primary);
        }
        
        #container { width: 100%; height: 100vh; position: relative; z-index: 1; }
        #bg-canvas { position: absolute; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0.6; }

        /* --- æ ‡é¢˜æ ·å¼ --- */
        .main-title {
            position: absolute; top: 5%; width: 100%; text-align: center; z-index: 10; pointer-events: none;
        }
        .main-title h1 {
            font-size: 3.5rem; margin: 0; font-weight: 800;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(118, 75, 162, 0.15); letter-spacing: 4px;
        }

        /* --- å¡ç‰‡æ ·å¼ --- */
        .element {
            width: 140px; height: 180px;
            background: rgba(255, 255, 255, 0.85);
            border: 2px solid #fff; border-top: 4px solid var(--theme-color); 
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 4px 10px var(--theme-shadow);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.4s; backdrop-filter: blur(4px); cursor: default;
        }
        .element:hover { transform: scale(1.1) translateY(-5px); background: #fff; z-index: 1000; }
        .element .name { font-size: 24px; font-weight: 700; color: var(--text-accent); margin-top: 5px; }
        .element .id-tag { font-size: 12px; color: #A0AEC0; background: #F7FAFC; padding: 2px 8px; border-radius: 10px; margin-bottom: 5px; }
        
        /* --- UI æ§åˆ¶æ  --- */
        #menu { position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 100; }
        .ctrl-panel { 
            background: rgba(255, 255, 255, 0.95); padding: 20px 40px; 
            border-radius: 50px; display: inline-flex; align-items: center; gap: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #fff;
        }
        
        button { 
            background: linear-gradient(135deg, #88C9D3 0%, #63b3ed 100%);
            border: none; color: white; padding: 12px 25px; cursor: pointer; font-size: 16px; 
            border-radius: 25px; font-weight: 600; transition: 0.3s; box-shadow: 0 5px 15px rgba(99, 179, 237, 0.3);
            white-space: nowrap;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 179, 237, 0.4); }
        
        /* è¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†æ ·å¼ */
        .input-group { display: flex; align-items: center; background: #EDF2F7; padding: 5px 15px; border-radius: 25px; }
        .input-group label { font-size: 14px; color: #718096; font-weight: bold; margin-right: 10px; }
        select, input { 
            background: transparent; border: none; color: var(--text-accent); 
            font-weight: bold; font-size: 16px; outline: none; text-align: center;
        }
        select { cursor: pointer; padding-right: 5px; }
        input { width: 50px; border-bottom: 2px solid #CBD5E0; }

        /* --- å¼¹çª—æ ·å¼ --- */
        #result-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.92); display: none; z-index: 200;
            flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(12px);
        }
        .winner-title {
            font-size: 3.5rem; color: #E53E3E; margin-bottom: 40px; font-weight: 900;
            text-shadow: 0 5px 15px rgba(229, 62, 62, 0.2); letter-spacing: 3px;
        }
        #result-container { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; max-width: 90%; }
        
        .winner-card {
            width: 200px; height: 260px; background: #fff;
            border: 4px solid #F6AD55; box-shadow: 0 20px 50px rgba(246, 173, 85, 0.25);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 48px; font-weight: 900; color: #2D3748; position: relative;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0;
        }
        .winner-card::before { content: "âœ¨"; position: absolute; top: -15px; left: -15px; font-size: 30px; }
        .winner-card::after { 
            content: attr(data-rank);
            position: absolute; bottom: 20px; font-size: 16px; 
            color: #F6AD55; font-weight: bold; letter-spacing: 2px;
        }
        @keyframes popIn {
            0% { transform: scale(0.5) translateY(50px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="main-title">
    <h1>2026é»å·å¿æ•™è‚²ä½“è‚²å±€å¹´ä¼šæŠ½å¥–</h1>
</div>

<canvas id="bg-canvas"></canvas>
<div id="container"></div>

<div id="menu">
    <div class="ctrl-panel">
        <input type="file" id="excel-file" hidden onchange="importExcel(this)">
        <button onclick="document.getElementById('excel-file').click()">ğŸ“‚ å¯¼å…¥åå•</button>
        
        <div class="input-group">
            <label>å¥–é¡¹</label>
            <select id="prize-select">
                <option value="ä¸‰ç­‰å¥–">ä¸‰ç­‰å¥–</option>
                <option value="äºŒç­‰å¥–">äºŒç­‰å¥–</option>
                <option value="ä¸€ç­‰å¥–" style="color:red; font-weight:bold;">ä¸€ç­‰å¥–</option>
            </select>
        </div>

        <div class="input-group">
            <label>äººæ•°</label>
            <input type="number" id="draw-count" value="1" min="1">
        </div>

        <button id="draw-btn" onclick="toggleDraw()">âœ¨ å¼€å§‹æŠ½å¥–</button>
        <button onclick="resetLottery()" style="background: #A0AEC0; font-size: 14px;">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰</button>
    </div>
</div>

<div id="result-mask">
    <div class="winner-title" id="winner-title-text">ğŸ‰ ä¸­å¥–åå• ğŸ‰</div>
    <div id="result-container"></div>
    <button onclick="closeResult()" style="margin-top: 60px; padding: 15px 60px; font-size: 18px; background: linear-gradient(135deg, #F6AD55 0%, #ED8936 100%);">æ”¶ä¸‹å–œæ‚¦</button>
</div>

<script>
    // é»˜è®¤æ¼”ç¤ºåå•
    let table = ["é™ˆå»ºå›½", "æç§€è‹±", "ç‹ä¼Ÿ", "å¼ æ•", "åˆ˜æ´‹", "èµµä¸½", "å­™å¼º", "å‘¨æ°", "å´å©·", "éƒ‘å¹³", "ææ ¹æ–°", "é©¬äº‘", "æ—ä¸¹", "å¼ ä¸‰", "æå››", "ç‹äº”"];
    
    // å…¨å±€å·²ä¸­å¥–åå•
    let globalWonList = []; 
    
    // å…³é”®äººç‰©é…ç½®
    const TARGET_NAME = "ææ ¹æ–°"; 

    // é…ç½®
    const cardThemes = [
        { color: '#88C9D3', shadow: 'rgba(136, 201, 211, 0.3)' },
        { color: '#E2D6EA', shadow: 'rgba(226, 214, 234, 0.4)' },
        { color: '#FFB7B2', shadow: 'rgba(255, 183, 178, 0.3)' },
        { color: '#B5EAD7', shadow: 'rgba(181, 234, 215, 0.3)' },
        { color: '#C7CEEA', shadow: 'rgba(199, 206, 234, 0.3)' }
    ];
    
    let camera, scene, renderer, bgScene, bgCamera, bgRenderer;
    let objects = [], particles;
    let isRotating = true;

    init();
    initParticles();
    animate();

    function init() {
        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.z = 3000;
        scene = new THREE.Scene();
        refreshSphere();
        renderer = new THREE.CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);
        window.addEventListener('resize', onWindowResize);
    }

    function initParticles() {
        bgRenderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
        bgRenderer.setSize(window.innerWidth, window.innerHeight);
        bgScene = new THREE.Scene();
        bgCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000);
        bgCamera.position.z = 1000;
        const geometry = new THREE.BufferGeometry();
        const vertices = []; const colors = [];
        for (let i = 0; i < 1500; i++) {
            vertices.push((Math.random() - 0.5) * 4000, (Math.random() - 0.5) * 4000, (Math.random() - 0.5) * 4000);
            const color = new THREE.Color(cardThemes[Math.floor(Math.random() * cardThemes.length)].color);
            colors.push(color.r, color.g, color.b);
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: 20, vertexColors: true, transparent: true, opacity: 0.8, map: createCircleTexture() });
        particles = new THREE.Points(geometry, material);
        bgScene.add(particles);
    }
    function createCircleTexture() {
        const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d'); ctx.beginPath(); ctx.arc(16, 16, 14, 0, 2 * Math.PI); ctx.fillStyle = 'white'; ctx.fill();
        return new THREE.CanvasTexture(canvas);
    }

    function refreshSphere() {
        for (let i = 0; i < objects.length; i++) scene.remove(objects[i]);
        objects = [];
        
        const displayList = table; 
        const l = displayList.length;
        for (let i = 0; i < l; i++) {
            const phi = Math.acos(-1 + (2 * i) / l);
            const theta = Math.sqrt(l * Math.PI) * phi;
            const element = document.createElement('div');
            element.className = 'element';
            const theme = cardThemes[i % cardThemes.length];
            element.style.setProperty('--theme-color', theme.color);
            element.style.setProperty('--theme-shadow', theme.shadow);
            
            if(globalWonList.includes(displayList[i])) {
                element.style.background = "#ddd";
                element.style.opacity = "0.5";
            }

            element.innerHTML = `<div class="id-tag">NO.${String(i+1).padStart(3, '0')}</div><div class="name">${displayList[i]}</div>`;
            const object = new THREE.CSS3DObject(element);
            object.position.setFromSphericalCoords(850, phi, theta);
            const vector = new THREE.Vector3().copy(object.position).multiplyScalar(2);
            object.lookAt(vector);
            scene.add(object);
            objects.push(object);
        }
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                
                // å…³é”®ä¿®æ­£ï¼šè¿™é‡ŒåŠ å…¥äº† .trim()ï¼Œé˜²æ­¢Excelé‡Œåå­—å¸¦ç©ºæ ¼å¯¼è‡´åŒ¹é…å¤±è´¥
                const newTable = json.map(r => r[0])
                    .filter(n => n && typeof n === 'string' && n.trim() !== "")
                    .map(n => n.trim()); 
                
                if(newTable.length > 0) {
                    table = newTable;
                    globalWonList = []; 
                    refreshSphere();
                } else { alert("âš ï¸ Excel æ•°æ®æ ¼å¼ä¸æ­£ç¡®"); }
            } catch (err) { alert("âŒ æ–‡ä»¶è§£æå¤±è´¥"); }
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function toggleDraw() {
        if (isRotating) {
            isRotating = false;
            document.getElementById('draw-btn').innerText = "ğŸ”„ é‡ç½®çƒä½“";
            document.getElementById('draw-btn').style.background = "#A0AEC0";
            const count = parseInt(document.getElementById('draw-count').value) || 1;
            const prizeType = document.getElementById('prize-select').value;
            executeDraw(count, prizeType);
        } else {
            isRotating = true;
            document.getElementById('draw-btn').innerText = "âœ¨ å¼€å§‹æŠ½å¥–";
            document.getElementById('draw-btn').style.background = "";
            closeResult();
        }
    }

    function executeDraw(count, prizeType) {
        // 1. è·å–åŸºç¡€å¯ç”¨æ± ï¼ˆæœªä¸­å¥–çš„äººï¼‰
        let availablePool = table.filter(name => !globalWonList.includes(name));

        // --- æ ¸å¿ƒé€»è¾‘åŠ å›ºï¼šä¿æŠ¤æœºåˆ¶ ---
        if (prizeType !== "ä¸€ç­‰å¥–") {
            // å¦‚æœä¸æ˜¯æŠ½ä¸€ç­‰å¥–ï¼ŒæŠŠææ ¹æ–°ä»æ± å­é‡Œç§»é™¤ã€‚
            // ç¡®ä¿ä»–ç»å¯¹ä¸ä¼šä¸å°å¿ƒä¸­äº†äºŒç­‰å¥–æˆ–ä¸‰ç­‰å¥–ã€‚
            availablePool = availablePool.filter(name => name !== TARGET_NAME);
        }
        // -----------------------------

        if (availablePool.length < count && prizeType !== "ä¸€ç­‰å¥–") {
            // å¦‚æœæ˜¯ä¸€ç­‰å¥–ä¸”äººæ•°ä¸å¤Ÿï¼Œå¯èƒ½éœ€è¦æŠŠè¢«ä¿æŠ¤çš„ææ ¹æ–°ç®—è¿›å»ï¼Œæ‰€ä»¥è¿™é‡Œåªåœ¨éä¸€ç­‰å¥–æ—¶æŠ¥é”™
            alert(`âš ï¸ å‰©ä½™äººæ•°ä¸è¶³ï¼`);
            return;
        }

        let currentBatchWinners = [];
        
        // --- æ ¸å¿ƒé€»è¾‘åŠ å›ºï¼šå¿…ä¸­æœºåˆ¶ ---
        if (prizeType === "ä¸€ç­‰å¥–") {
            // æ£€æŸ¥ä»–æ˜¯å¦æœªä¸­å¥–ï¼ˆç”±äºä¸Šé¢çš„ä¿æŠ¤æœºåˆ¶ï¼Œä»–åº”è¯¥ä¸€ç›´åœ¨æœªä¸­å¥–åå•é‡Œï¼‰
            if (!globalWonList.includes(TARGET_NAME)) {
                // åªè¦ä»–æ²¡ä¸­è¿‡å¥–ï¼Œä¸ç®¡æ± å­é‡Œæœ‰æ²¡æœ‰ï¼ˆç†è®ºä¸Šæœ‰ï¼‰ï¼Œå¼ºåˆ¶æ·»åŠ 
                currentBatchWinners.push(TARGET_NAME);
                
                // ä»å¯ç”¨æ± ä¸­ç§»é™¤ä»–ï¼Œé¿å…é‡å¤é€‰ä¸­ï¼ˆå¦‚æœä»–åœ¨æ± å­é‡Œçš„è¯ï¼‰
                const idx = availablePool.indexOf(TARGET_NAME);
                if (idx > -1) availablePool.splice(idx, 1);
                
                // å ç”¨ä¸€ä¸ªåé¢
                count--; 
                console.log(`ğŸ¯ ${TARGET_NAME} å·²å†…å®šé”å®š`);
            }
        }
        // -----------------------------

        // éšæœºå¡«å……å‰©ä½™åé¢
        for (let i = 0; i < count; i++) {
            if (availablePool.length === 0) break;
            const randomIndex = Math.floor(Math.random() * availablePool.length);
            const winner = availablePool[randomIndex];
            currentBatchWinners.push(winner);
            availablePool.splice(randomIndex, 1); 
        }

        // è®°å½•ç»“æœ
        globalWonList = globalWonList.concat(currentBatchWinners);
        refreshSphere();
        showResults(currentBatchWinners, prizeType);
    }

    function showResults(names, prizeTitle) {
        const container = document.getElementById('result-container');
        container.innerHTML = '';
        document.getElementById('winner-title-text').innerText = `ğŸ‰ ${prizeTitle}åå• ğŸ‰`;
        
        names.forEach((name, index) => {
            const card = document.createElement('div');
            card.className = 'winner-card';
            card.innerText = name;
            card.setAttribute('data-rank', prizeTitle);
            card.style.animationDelay = `${index * 0.1}s`;
            container.appendChild(card);
        });
        document.getElementById('result-mask').style.display = 'flex';
    }

    function closeResult() {
        document.getElementById('result-mask').style.display = 'none';
    }
    
    function resetLottery() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸­å¥–è®°å½•ï¼Œé‡æ–°å¼€å§‹å—ï¼Ÿ")) {
            globalWonList = [];
            refreshSphere();
            alert("å·²é‡ç½®ï¼Œæ‰€æœ‰äººå‡å¯å†æ¬¡ä¸­å¥–ã€‚");
        }
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        bgCamera.aspect = window.innerWidth / window.innerHeight; bgCamera.updateProjectionMatrix();
        bgRenderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        if (isRotating) { scene.rotation.y += 0.003; scene.rotation.x += 0.001; }
        if(particles) { particles.rotation.y -= 0.0005; particles.rotation.x += 0.0002; }
        renderer.render(scene, camera);
        bgRenderer.render(bgScene, bgCamera);
    }
</script>

</body>
</html>